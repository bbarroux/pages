<html lang="en">
<body>
<pre>Please wait while you're being signed in...</pre>
<script>
    const FFAL = {
        login(tenant, idp, showForm) {
            const params = new URLSearchParams(window.location.search);
            const server = params.get("fficaas") || "go.fficaas.net";
            const formEltStyle = `padding: 4px 6px;margin:5px; border: 1px solid #dac1ff5e;color: #7952b3;border-radius: 3px;margin-right: 20px;box-shadow: inset 0 1px 2px rgba(0, 0, 0, .39), 0 -1px 1px #FFF, 0 1px 0 #FFF`
            const formHtml = `
                    <div style="position:absolute;width:100%;height:100%;opacity:0.3;z-index:100;background:#000;"></div>
                    <div style="position:absolute;width: 300px; padding:20px; height: 200px; top:0;left:0; bottom:0; right:0;margin: auto; overflow: auto; z-index:101;background-color: white">
                        <label for="ffs-tenant">Tenant&nbsp;</label>
                        <input id="ffs-tenant" checked="checked"  style="${formEltStyle}"><br/>
                        <label for="ffs-idp">Idp Channel&nbsp;</label>
                        <select id="ffs-idp" style="${formEltStyle}">
                            <option value="employee">Employee</option>
                            <option value="consumer">Consumer</option>
                        </select><br/>
                        <button onclick="
                            const val=(id)=>document.getElementById(id).value;
                            window.location = 'https://${server}/login/popup/'+ val('ffs-tenant') + '/' + val('ffs-idp') + '?redirect_uri=${window.location.href}'
                            ">Sign In</button>
                    </div>
                    `;
            const request = (relUrl, init) => fetch(`https://${server}/${relUrl}`, {
                ...(init || {}),
                credentials: "include"
            });
            const requestJson = (relUrl, init) => request(relUrl, init).then(r => r.json());
            const connectionTpl = {
                fetch: (api, init) => request(`api/${api}`, init),
                fetchJson: (api, init) => requestJson(`api/${api}`, init),
                signout: (url) => (window.location = `${server}/signout?redirect_uri=${url || window.location.href}`)
            }
            const showLoginForm = () => {
                const loginForm = document.createElement("div")
                document.body.appendChild(loginForm);
                loginForm.innerHTML = formHtml;
            }

            function getSigninUrl() {
                const signinTenant = tenant || user.tenant || params.get("tenant");
                const signinIdp = idp || user.idp || params.get("idp");
                if (!signinTenant || !signinIdp) return null;
                return `https://${server}/login/popup/${signinTenant}/${signinIdp}?redirect_uri=${window.location.href}`;
            }

            return new Promise((resolve, reject) => {
                requestJson("user").catch(() => ({})).then(user => {
                    console.log(`got user ${user.name}`)
                    if (user.access) {
                        console.log(`User logged in ${user.name}.`)
                        resolve({user, ...connectionTpl});
                    } else {
                        const signinUrl = getSigninUrl();
                        if (signinUrl) {
                            console.log(`initiating login on ${signinUrl}`)
                            window.location = signinUrl;
                            //promise never resolved
                        } else {
                            console.log(`Missing idp or tenant (tenant:${tenant}/idp:${idp})`)
                            if (showForm) {
                                showLoginForm();
                                //promise never resolved
                            } else {
                                reject(`Missing idp or tenant (tenant:${tenant}/idp:${idp})`);
                            }
                        }
                    }
                }).catch(e => reject("Error while checking connection status : " + e));
            });
        }
    }

</script>
<script>
    (async () => {
        const conn = await FFAL.login(null, "consumer");
        const accounts = await conn.fetchJson("retail-us/me/account/v1/accounts/extendedWithDetails");
        document.body.firstElementChild.innerText = `You have ${accounts.length} bank accounts.`;
    })();
</script>
</body>
</html>
